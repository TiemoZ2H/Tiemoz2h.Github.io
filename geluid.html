<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wat is geluid? ‚Äì Compact (tijdvenster & mute)</title>
  <style>
    :root{ --gap:12px; --canvas-h:150px; }
    *{ box-sizing:border-box }
    html, body{ height:100%; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f0f6ff; color:#222; display:grid; grid-template-rows:auto 1fr; overflow:hidden;
    }
    header{ padding:10px 14px; border-bottom:1px solid #cfe3ff; text-align:center; }
    header h1{ font-size:18px; margin:0; color:#0055cc }
    header p{ margin:4px 0 0; font-size:14px; opacity:.85 }
    main{
      display:grid; grid-template-columns: 1.1fr 1fr;
      gap: var(--gap); padding: var(--gap); max-width: 1200px; width:100%; margin:0 auto;
      align-items:stretch;
    }
    .card{
      background:#ffffff; border:2px solid #007bff22; border-radius:12px;
      box-shadow:0 4px 10px #0001; padding:12px; height:100%;
      display:grid; grid-auto-rows: max-content; gap:10px; overflow:hidden;
    }
    .controls .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center; }
    .controls label{ font-weight:600; font-size:14px; display:block; }
    .controls input[type="range"]{ width:100% }
    .val{ font-variant-numeric: tabular-nums }
    .hint{ font-size:12px; opacity:.75 }
    .btn{
      background:#007bff; color:#fff; border:0; border-radius:10px;
      padding:8px 12px; font-size:14px; cursor:pointer;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .toggle{
      background:#e7f0ff; color:#0d47a1; border:1px solid #bcd7ff; border-radius:999px;
      padding:6px 10px; font-size:13px; cursor:pointer;
    }
    .select{
      background:#e7f0ff; color:#0d47a1; border:1px solid #bcd7ff; border-radius:8px;
      padding:6px 8px; font-size:13px;
    }
    .badges{ display:flex; flex-wrap:wrap; gap:6px }
    .badge{ font-size:11px; background:#e7f0ff; border:1px solid #bcd7ff; color:#0d47a1; border-radius:999px; padding:2px 8px }
    .title{ font-weight:800; color:#0055cc; font-size:14px; margin:0 }
    .legend{ font-size:12px; opacity:.85 }
    .canvas-wrap{ display:grid; gap:8px; grid-auto-rows: max-content; }
    canvas{
      background:#fff; border:2px solid #007bff; border-radius:10px;
      width:100%; height:var(--canvas-h); display:block;
    }
    @media (max-height: 740px){ :root{ --canvas-h: 130px } }
    @media (max-width: 1000px){ main{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 820px){ body{ overflow:auto } main{ grid-template-columns:1fr; height:auto } }
  </style>
</head>
<body>
  <header>
    <h1>Wat is geluid?</h1>
    <p>Geluid is <b>lucht die trilt</b>. Trillingen hebben <b>frequentie</b> (snel) en <b>amplitude</b> (groot).</p>
  </header>

  <main>
    <!-- Linkerkolom: bediening -->
    <section class="card controls">
      <div class="row">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <button id="startBtn" class="btn">üé∂ Start geluid</button>
          <button id="muteBtn" class="toggle" disabled>üîá Stil (alleen kijken)</button>
        </div>
        <div class="badges">
          <span class="badge">Frequentie = toonhoogte</span>
          <span class="badge">Amplitude = luidheid</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Toonhoogte (frequentie): <span id="fVal" class="val">220</span> Hz</label>
          <!-- max naar 2000 Hz zodat 20 ms ‚âà 40 periodes -->
          <input id="freq" type="range" min="100" max="2000" value="220" step="1" aria-label="frequentie">
          <div class="hint">Hoger = hogere toon (fluit). Lager = lagere toon (brom).</div>
        </div>
        <div>
          <label>Luidheid (amplitude): <span id="aVal" class="val">0.30</span></label>
          <input id="amp" type="range" min="0" max="1" value="0.30" step="0.01" aria-label="amplitude">
          <div class="hint">Grotere amplitude = harder. Kleinere amplitude = zachter.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label><input type="checkbox" id="lock" checked> Golf stabiliseren (trigger)</label>
          <div class="hint">Zet de golf ‚Äústil‚Äù op hetzelfde startpunt.</div>
        </div>
        <div>
          <label>Weergave</label>
          <select id="viewMode" class="select" aria-label="weergave">
            <option value="time" selected>Vaste tijd (ms)</option>
            <option value="cycles">Vast aantal periodes</option>
          </select>
        </div>
      </div>

      <!-- tijdvenster (voor vaste tijd) -->
      <div class="row" id="timeRow">
        <div>
          <label>Tijdvenster: <span id="winVal" class="val">20</span> ms</label>
          <input id="winMs" type="range" min="10" max="200" step="5" value="20" aria-label="tijdvenster (ms)">
          <div class="hint">Bij 2000 Hz ‚âà 40 periodes, bij 100 Hz ‚âà 2 periodes.</div>
        </div>
      </div>

      <!-- periodes (voor vaste periodes) -->
      <div class="row" id="cyclesRow" style="display:none">
        <div>
          <label>Periodes tonen: <span id="cyclesVal" class="val">2</span></label>
          <input type="range" id="cycles" min="1" max="8" step="1" value="2" aria-label="periodes">
          <div class="hint">Vaste hoeveelheid golfjes, ongeacht de toonhoogte.</div>
        </div>
      </div>
    </section>

    <!-- Rechterkolom: visualisaties -->
    <section class="card">
      <div class="canvas-wrap">
        <div>
          <div class="title">üëÄ Geluidsgolf (tijd)</div>
          <canvas id="wave"></canvas>
          <div class="legend">Bij een hogere toon passen meer golfjes in hetzelfde tijdvak.</div>
        </div>
        <div>
          <div class="title">üìà Spectrum (frequenties)</div>
          <canvas id="spectrum"></canvas>
          <div class="legend">Piek ‚âà <b><span id="peakHz">‚Äî</span> Hz</b> (de toonhoogte).</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ==== Audio nodes & state ====
    let ctx, osc, gain, analyser;
    let rafWave, rafSpec;
    let soundOn = true; // bepaalt of er naar de speakers wordt gestuurd

    // ==== UI refs ====
    const startBtn = document.getElementById('startBtn');
    const muteBtn  = document.getElementById('muteBtn');
    const freq = document.getElementById('freq');
    const amp  = document.getElementById('amp');
    const fVal = document.getElementById('fVal');
    const aVal = document.getElementById('aVal');
    const lockChk = document.getElementById('lock');

    const viewMode = document.getElementById('viewMode');
    const timeRow  = document.getElementById('timeRow');
    const cyclesRow= document.getElementById('cyclesRow');

    const winMs    = document.getElementById('winMs');
    const winVal   = document.getElementById('winVal');

    const cycles   = document.getElementById('cycles');
    const cyclesVal= document.getElementById('cyclesVal');

    const peakHzEl = document.getElementById('peakHz');

    // canvassen
    const wave = document.getElementById('wave');
    const spectrum = document.getElementById('spectrum');
    const wg = wave.getContext('2d');
    const sg = spectrum.getContext('2d');

    // DPI helper
    function fitCanvas(cvs){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = cvs.getBoundingClientRect();
      const cssH = rect.height || parseFloat(getComputedStyle(cvs).height);
      cvs.width  = Math.floor(rect.width * dpr);
      cvs.height = Math.floor(cssH * dpr);
      return dpr;
    }
    window.addEventListener('resize', () => { fitCanvas(wave); fitCanvas(spectrum); });

    // UI labels
    cycles.addEventListener('input', () => cyclesVal.textContent = cycles.value);
    winMs.addEventListener('input', () => winVal.textContent = winMs.value);
    viewMode.addEventListener('change', () => {
      const mode = viewMode.value;
      timeRow.style.display   = (mode === 'time')   ? '' : 'none';
      cyclesRow.style.display = (mode === 'cycles') ? '' : 'none';
    });

    // ===== Reconnect graph afhankelijk van mute =====
    function reconnectGraph(){
      if (!gain || !analyser) return;
      try { gain.disconnect(); } catch(e){}
      gain.connect(analyser);           // visuals altijd
      if (soundOn && ctx) gain.connect(ctx.destination); // speakers alleen als aan
      muteBtn.textContent = soundOn ? "üîá Stil (alleen kijken)" : "üîä Geluid aan";
      muteBtn.setAttribute('aria-pressed', String(!soundOn));
    }

    // ==== Init audio ====
    startBtn.addEventListener('click', async () => {
      if (ctx) return;
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      await ctx.resume();

      osc = ctx.createOscillator();
      gain = ctx.createGain();
      analyser = ctx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.6;

      // start lager: 220 Hz
      osc.type = 'sine';
      osc.frequency.value = parseFloat(freq.value); // 220 by default
      gain.gain.value = parseFloat(amp.value);

      osc.connect(gain);
      reconnectGraph();       // -> analyser (altijd) + eventueel destination
      osc.start();

      startBtn.disabled = true;
      muteBtn.disabled  = false;

      fitCanvas(wave);
      fitCanvas(spectrum);
      drawWave();
      drawSpectrum();
    });

    // ==== Mute toggle ====
    muteBtn.addEventListener('click', () => {
      soundOn = !soundOn;
      reconnectGraph(); // visuals blijven werken
    });

    // ==== UI bindings ====
    freq.addEventListener('input', () => {
      const v = parseFloat(freq.value);
      fVal.textContent = v.toFixed(0);
      if (osc) osc.frequency.value = v;
    });
    amp.addEventListener('input', () => {
      const v = parseFloat(amp.value);
      aVal.textContent = v.toFixed(2);
      if (gain) gain.gain.value = v;
    });

    // ==== Wave helpers ====
    function findPeriodSamples(timeData){
      let i1 = -1, i2 = -1;
      for (let i=1;i<timeData.length;i++){
        const prev = timeData[i-1] - 128;
        const curr = timeData[i]   - 128;
        if (prev < 0 && curr >= 0){ if (i1 === -1) i1 = i; else { i2 = i; break; } }
      }
      const period = (i1 !== -1 && i2 !== -1) ? (i2 - i1) : null;
      return { i1, period };
    }

    // ==== Wave drawing: 2 modes (time / cycles) ====
    function drawWave(){
      fitCanvas(wave);
      const w = wave.width, h = wave.height;
      const timeData = new Uint8Array(analyser.fftSize);
      analyser.getByteTimeDomainData(timeData);

      let startIndex = 0;
      let samplesToShow = timeData.length;

      // Trigger voor stabiele start
      let period = null, triggerIndex = -1;
      if (lockChk.checked){
        const res = findPeriodSamples(timeData);
        triggerIndex = res.i1; period = res.period;
        if (triggerIndex !== -1) startIndex = triggerIndex;
      }

      // MODE: vaste tijd -> aantal samples = sampleRate * windowMs
      if (viewMode.value === 'time'){
        const sr = ctx ? ctx.sampleRate : 44100;
        const samplesForWindow = Math.max(16, Math.round((winMs.value/1000) * sr));
        samplesToShow = Math.min(samplesForWindow, timeData.length - 1);
        // (optioneel) toon geschat aantal periodes in dit venster
        if (period){
          const f = sr / period;
          fVal.textContent = Math.round(f);
        }
      } else {
        // MODE: vast aantal periodes -> N * period
        if (period && period > 4){
          const N = parseInt(cycles.value, 10);
          samplesToShow = Math.min(N * period, timeData.length);
          const sr = ctx ? ctx.sampleRate : 44100;
          fVal.textContent = Math.round(sr / period);
        }
      }

      wg.clearRect(0,0,w,h);

      // grid en middenlijn
      wg.globalAlpha = 0.07; wg.fillStyle = "#000";
      for (let x=0;x<w;x+=Math.floor(w/10)) wg.fillRect(x,0,1,h);
      for (let y=0;y<h;y+=Math.floor(h/4))  wg.fillRect(0,y,w,1);
      wg.globalAlpha = .25; wg.fillRect(0, h/2, w, 1); wg.globalAlpha = 1;

      // golf tekenen
      wg.lineWidth = 2; wg.strokeStyle = "#007bff"; wg.beginPath();
      const stepX = w / samplesToShow;
      for (let k=0;k<samplesToShow;k++){
        const idx = (startIndex + k) % timeData.length;
        const v = (timeData[idx]-128)/128;
        const x = k * stepX;
        const y = h/2 + v * h * 0.40;
        if (k===0) wg.moveTo(x,y); else wg.lineTo(x,y);
      }
      wg.stroke();

      rafWave = requestAnimationFrame(drawWave);
    }

    // ==== Spectrum (met pieklabel) ====
    function drawSpectrum(){
      fitCanvas(spectrum);
      const w = spectrum.width, h = spectrum.height;
      const bins = analyser.frequencyBinCount;
      const data = new Uint8Array(bins);
      analyser.getByteFrequencyData(data);

      sg.clearRect(0,0,w,h);

      // bars
      const barW = Math.max(1, Math.floor(w / bins));
      let maxIdx = 0, maxVal = -1;
      for (let i=0;i<bins;i++){
        const v = data[i]; if (v > maxVal){ maxVal = v; maxIdx = i; }
        const mag = v/255, barH = mag*h, x = i*barW;
        const g = sg.createLinearGradient(0,h-barH,0,h);
        g.addColorStop(0,"#9bd0ff"); g.addColorStop(1,"#007bff");
        sg.fillStyle = g; sg.fillRect(x, h-barH, barW-1, barH);
      }

      // piek & label
      const sampleRate = ctx ? ctx.sampleRate : 44100;
      const nyquist = sampleRate/2;
      const peakFreq = (maxIdx/bins)*nyquist;
      peakHzEl.textContent = Math.round(peakFreq);

      const peakX = maxIdx*barW + Math.floor(barW/2);
      sg.strokeStyle = "#ff5a36"; sg.lineWidth = 2;
      sg.beginPath(); sg.moveTo(peakX,0); sg.lineTo(peakX,h); sg.stroke();
      sg.fillStyle = "#ff5a36"; sg.font = "12px Arial";
      sg.fillText(`‚âà ${Math.round(peakFreq)} Hz`, Math.min(peakX+6, w-80), 14);

      // grove labels
      sg.fillStyle = "#333"; sg.font = "11px Arial";
      [100,300,600,1000,1500,2000].forEach(f=>{
        const idx = Math.floor((f/nyquist)*bins);
        const x = idx * barW;
        sg.globalAlpha = .15; sg.fillRect(x,0,1,h); sg.globalAlpha = 1;
        sg.fillText(`${f} Hz`, x+4, h-6);
      });

      rafSpec = requestAnimationFrame(drawSpectrum);
    }

    // netjes opruimen
    window.addEventListener('beforeunload', () => {
      cancelAnimationFrame(rafWave); cancelAnimationFrame(rafSpec);
      try { osc && osc.stop(); } catch {}
      try { ctx && ctx.close(); } catch {}
    });

    // Bonus: sneltoets M voor mute
    window.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'm' && muteBtn && !muteBtn.disabled){
        e.preventDefault(); muteBtn.click();
      }
    });
  </script>
</body>
</html>
